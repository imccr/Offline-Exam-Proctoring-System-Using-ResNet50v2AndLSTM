<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OEPS - Offline Exam Proctoring System</title>
<link href="/static/output.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Rajdhani', sans-serif; }
  .fm { font-family: 'Share Tech Mono', monospace; }
  @keyframes pd { 0%,100%{opacity:1} 50%{opacity:0.3} }
  .pd { animation: pd 1.5s infinite; }
  @keyframes fi { from{opacity:0;transform:translateY(-4px)} to{opacity:1;transform:none} }
  .fi { animation: fi 0.3s ease; }
  .uzone:hover, .uzone.dv { border-color:#58a6ff; box-shadow:0 0 24px rgba(88,166,255,0.12); }
  #rp::-webkit-scrollbar, #al::-webkit-scrollbar { width:3px; }
  #rp::-webkit-scrollbar-thumb, #al::-webkit-scrollbar-thumb { background:#30363d; border-radius:2px; }
  body::before { content:''; position:fixed; inset:0;
    background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.025) 2px,rgba(0,0,0,0.025) 4px);
    pointer-events:none; z-index:9999; }
</style>
</head>
<body class="bg-dark text-gray-200 min-h-screen overflow-x-hidden">

<!-- Header -->
<header class="bg-panel border-b border-border px-7 py-4 flex items-center gap-4">
  <div class="w-2.5 h-2.5 rounded-full bg-accent pd" style="box-shadow:0 0 8px #58a6ff"></div>
  <span class="fm text-accent text-xs tracking-widest">&#9679; OEPS v2.0 &mdash; ResNet Monitor</span>
  <span class="fm text-muted text-xs ml-auto" id="hs">IDLE</span>
</header>

<!-- ── Upload Section ─────────────────────────────────────────────────────── -->
<div id="us" class="flex flex-col items-center justify-center min-h-[calc(100vh-57px)] px-5 py-10">
  <h1 class="text-3xl font-bold text-center tracking-wide leading-snug max-w-2xl mb-2">
    Offline Exam Proctoring System Using<br>
    <span class="text-accent">Pose Estimation</span> with Fine-Tuned ResNet50V2
  </h1>
  <p class="fm text-muted text-xs tracking-widest uppercase text-center mb-12">
    Institute of Engineering &nbsp;|&nbsp; Thapathali Campus &nbsp;|&nbsp; BCT 2079
  </p>

  <!-- Two input options -->
  <div class="flex gap-6 w-full max-w-2xl">

    <!-- Upload Video -->
    <div class="flex-1">
      <div id="uz" class="uzone w-full bg-panel border-2 border-dashed border-border rounded-xl text-center cursor-pointer transition-all duration-300" style="padding: 80px 24px;">
        <div class="text-5xl mb-4 opacity-60">&#127909;</div>
        <div class="text-lg font-semibold mb-2">Drop exam video here</div>
        <div class="fm text-muted text-xs tracking-wide">MP4 &nbsp;·&nbsp; AVI &nbsp;·&nbsp; MOV &nbsp;·&nbsp; MKV</div>
        <input type="file" id="fi" accept="video/*" class="hidden">
      </div>
      <div id="sf" class="hidden mt-3 fm text-green-400 text-xs text-center"></div>
    </div>

    <!-- Webcam -->
    <div class="flex-1">
      <div class="uzone w-full bg-panel border-2 border-dashed border-border rounded-xl text-center cursor-pointer transition-all duration-300 flex flex-col items-center justify-center" style="padding: 80px 24px;" onclick="startWebcam()">
        <div class="text-5xl mb-4 opacity-60">&#128247;</div>
        <div class="text-lg font-semibold mb-2">Start Webcam</div>
        <div class="fm text-muted text-xs tracking-wide">Live camera feed</div>
      </div>
    </div>

  </div>

  <!-- Upload progress -->
  <div id="ps" class="hidden text-center mt-8 w-full max-w-2xl">
    <div class="fm text-muted text-xs mb-3" id="pt">Uploading video...</div>
    <div class="h-1 bg-border rounded-full overflow-hidden">
      <div id="uprog" class="h-full bg-accent rounded-full transition-all duration-300" style="width:0%;box-shadow:0 0 8px #58a6ff"></div>
    </div>
  </div>
</div>

<!-- ── Monitor Section ────────────────────────────────────────────────────── -->
<div id="ms" class="hidden flex-col gap-4 p-5">

  <!-- Top bar -->
  <div class="flex items-center gap-3 pb-3 border-b border-border">
    <div class="w-2 h-2 rounded-full bg-red-500 pd" id="rd" style="box-shadow:0 0 6px #ef4444"></div>
    <span class="fm text-accent text-xs tracking-widest" id="feed-label">LIVE PROCTORING FEED</span>

  </div>

  <div class="flex gap-4 items-start">

    <!-- Video Feed -->
    <div class="flex-1 bg-black rounded-lg border border-border overflow-hidden relative min-h-64">
      <div class="absolute top-2 left-2 fm text-accent text-xs bg-black/70 px-2 py-1 rounded border border-border z-10" id="fl">
        FRAME 0 / 0
      </div>
      <img id="vf" src="" alt="Processing..." class="w-full block rounded-lg">
    </div>

    <!-- Side Panels -->
    <div class="w-56 flex flex-col gap-3 shrink-0">

      <!-- Live Stats -->
      <div class="bg-panel border border-border rounded-lg p-3">
        <div class="fm text-accent text-xs tracking-widest mb-3">LIVE STATS</div>
        <div class="flex justify-between py-1 text-sm">
          <span class="text-muted">Students</span>
          <span class="text-accent font-semibold" id="ss">0</span>
        </div>
        <div class="flex justify-between py-1 text-sm">
          <span class="text-muted flex items-center gap-1.5">
            <span class="inline-block w-1.5 h-1.5 rounded-full bg-green-500"></span>Normal
          </span>
          <span class="text-green-400 font-semibold" id="sn">0</span>
        </div>
        <div class="flex justify-between py-1 text-sm">
          <span class="text-muted flex items-center gap-1.5">
            <span class="inline-block w-1.5 h-1.5 rounded-full bg-red-500"></span>Suspicious
          </span>
          <span class="text-red-400 font-semibold" id="sx">0</span>
        </div>
        <div class="flex justify-between py-1 text-sm">
          <span class="text-muted">Elapsed</span>
          <span class="font-semibold" id="se">00:00</span>
        </div>

        <!-- Progress bar — hidden for webcam -->
        <div id="progress-wrap" class="bg-gray-800 rounded h-1.5 mt-2">
          <div id="vp" class="bg-accent h-1.5 rounded transition-all duration-500" style="width:0%"></div>
        </div>

        <!-- Pause/Play — only for file video -->
        <button id="pauseBtn" onclick="togglePause()"
          class="hidden mt-3 w-full py-2 bg-yellow-600 hover:bg-yellow-500 text-white text-xs font-bold tracking-widest rounded transition-colors duration-200">
          &#9646;&#9646; PAUSE
        </button>

        <!-- Stop button -->
        <button id="stopBtn" onclick="stopProctoring()"
          class="mt-3 w-full py-2 bg-red-600 hover:bg-red-500 text-white text-xs font-bold tracking-widest rounded transition-colors duration-200">
          &#9632; STOP
        </button>

        <!-- Load New Video — shown after video completes -->
        <button id="newVideoBtn" onclick="resetToUpload()"
          class="hidden mt-3 w-full py-2 bg-accent hover:bg-blue-300 text-dark text-xs font-bold tracking-widest rounded transition-colors duration-200">
          &#8635; LOAD NEW VIDEO
        </button>
      </div>

      <!-- ResNet Probs -->
      <div class="bg-panel border border-border rounded-lg p-3">
        <div class="fm text-accent text-xs tracking-widest mb-3">RESNET PROBS</div>
        <div id="rp" class="max-h-40 overflow-y-auto">
          <span class="fm text-muted text-xs">Waiting...</span>
        </div>
      </div>

      <!-- Performance -->
      <div class="bg-panel border border-border rounded-lg p-3">
        <div class="fm text-accent text-xs tracking-widest mb-3">PERFORMANCE</div>
        <div class="flex justify-between py-1 text-sm">
          <span class="text-muted">Display FPS</span>
          <span class="text-green-400 font-semibold" id="disp-fps">--</span>
        </div>
        <div class="flex justify-between py-1 text-sm">
          <span class="text-muted">Inference FPS</span>
          <span class="text-accent font-semibold" id="inf-fps">--</span>
        </div>
        <div class="flex justify-between py-1 text-sm">
          <span class="text-muted">Frame</span>
          <span class="font-semibold" id="pfr">--</span>
        </div>
      </div>

    </div>
  </div>

  <!-- Suspicious Activity Log -->
  <div class="bg-panel border border-border rounded-lg p-3">
    <div class="fm text-accent text-xs tracking-widest mb-3">SUSPICIOUS ACTIVITY LOG</div>
    <div id="al" class="max-h-32 overflow-y-auto">
      <span class="fm text-muted text-xs empty-log">No suspicious activity detected.</span>
    </div>
  </div>

  <div id="db" class="hidden bg-green-900/20 border border-green-500 rounded-lg p-3 text-center fm text-green-400 text-sm">
    &#10003; Processing complete. All frames analysed.
  </div>

</div>

<!-- ── JavaScript ─────────────────────────────────────────────────────────── -->
<script>
const API = 'http://localhost:8000';
const $   = id => document.getElementById(id);

let selectedFile = null;
let currentJobId = null;
let currentMode  = null;
let es           = null;
let isPaused     = false;

// ── File Selection — auto start on select ─────────────────────────────────────
$('uz').addEventListener('click', () => $('fi').click());

['dragover', 'dragleave', 'drop'].forEach(evt =>
  $('uz').addEventListener(evt, e => {
    e.preventDefault();
    $('uz').classList.toggle('dv', evt === 'dragover');
    if (evt === 'drop' && e.dataTransfer.files[0]) setFile(e.dataTransfer.files[0]);
  })
);

$('fi').addEventListener('change', () => {
  if ($('fi').files[0]) setFile($('fi').files[0]);
});

function setFile(f) {
  selectedFile = f;
  $('sf').textContent = `▶ ${f.name} (${(f.size / 1024 / 1024).toFixed(1)} MB)`;
  $('sf').classList.remove('hidden');
  startVideoProctoring();
}

// ── Start Video Proctoring ────────────────────────────────────────────────────
function startVideoProctoring() {
  if (!selectedFile) return;
  currentMode = 'video';
  $('ps').classList.remove('hidden');
  $('hs').textContent = 'UPLOADING...';

  const fd  = new FormData();
  fd.append('file', selectedFile);

  const xhr = new XMLHttpRequest();
  xhr.open('POST', `${API}/upload`);

  xhr.upload.onprogress = e => {
    if (e.lengthComputable) {
      const p = (e.loaded / e.total * 100).toFixed(0);
      $('uprog').style.width = p + '%';
      $('pt').textContent    = 'Uploading... ' + p + '%';
    }
  };

  xhr.onload = () => {
    if (xhr.status === 200) {
      const { job_id } = JSON.parse(xhr.responseText);
      currentJobId               = job_id;
      $('pt').textContent        = 'Processing started...';
      $('hs').textContent        = 'PROCESSING';
      $('us').style.display      = 'none';
      $('ms').style.display      = 'flex';
      $('feed-label').textContent = 'LIVE PROCTORING FEED';
      $('pauseBtn').classList.remove('hidden');
      $('stopBtn').classList.remove('hidden');
      $('newVideoBtn').classList.add('hidden');
      $('progress-wrap').classList.remove('hidden');
      isPaused = false;
      startStream(job_id);
    } else {
      alert('Upload failed: ' + xhr.statusText);
    }
  };

  xhr.send(fd);
}

// ── Start Webcam ──────────────────────────────────────────────────────────────
async function startWebcam() {
  currentMode = 'webcam';
  $('hs').textContent        = 'STARTING WEBCAM...';
  $('us').style.display      = 'none';
  $('ms').style.display      = 'flex';
  $('feed-label').textContent = 'WEBCAM LIVE FEED';
  $('pauseBtn').classList.add('hidden');
  $('newVideoBtn').classList.add('hidden');
  $('stopBtn').classList.remove('hidden');
  $('progress-wrap').classList.add('hidden');

  const res        = await fetch(`${API}/start_webcam`, { method: 'POST' });
  const { job_id } = await res.json();
  currentJobId     = job_id;
  $('hs').textContent = 'WEBCAM LIVE';
  startStream(job_id);
}

// ── Pause / Play ──────────────────────────────────────────────────────────────
async function togglePause() {
  if (!currentJobId) return;
  const res  = await fetch(`${API}/pause/${currentJobId}`, { method: 'POST' });
  const data = await res.json();
  isPaused   = data.paused;
  $('pauseBtn').innerHTML  = isPaused ? '&#9654; PLAY' : '&#9646;&#9646; PAUSE';
  $('pauseBtn').className  = isPaused
    ? 'mt-3 w-full py-2 bg-green-600 hover:bg-green-500 text-white text-xs font-bold tracking-widest rounded transition-colors duration-200'
    : 'mt-3 w-full py-2 bg-yellow-600 hover:bg-yellow-500 text-white text-xs font-bold tracking-widest rounded transition-colors duration-200';
}

// ── Stop Proctoring ───────────────────────────────────────────────────────────
async function stopProctoring() {
  if (currentJobId) {
    await fetch(`${API}/stop/${currentJobId}`, { method: 'POST' }).catch(() => {});
  }
  if (es) { es.close(); es = null; }
  resetToUpload();
}

// ── Reset to Upload Page ──────────────────────────────────────────────────────
function resetToUpload() {
  if (es) { es.close(); es = null; }

  $('ms').style.display = 'none';
  $('us').style.display = 'flex';
  $('hs').textContent   = 'IDLE';

  $('sf').classList.add('hidden');
  $('ps').classList.add('hidden');
  $('uprog').style.width    = '0%';
  $('db').classList.add('hidden');
  $('rd').style.background  = '#ef4444';
  $('pauseBtn').innerHTML   = '&#9646;&#9646; PAUSE';
  $('pauseBtn').className   = 'hidden mt-3 w-full py-2 bg-yellow-600 hover:bg-yellow-500 text-white text-xs font-bold tracking-widest rounded transition-colors duration-200';
  $('stopBtn').classList.remove('hidden');
  $('newVideoBtn').classList.add('hidden');
  $('progress-wrap').classList.remove('hidden');

  $('al').innerHTML         = '<span class="fm text-muted text-xs empty-log">No suspicious activity detected.</span>';
  $('rp').innerHTML         = '<span class="fm text-muted text-xs">Waiting...</span>';
  $('ss').textContent       = '0';
  $('sn').textContent       = '0';
  $('sx').textContent       = '0';
  $('se').textContent       = '00:00';
  $('vp').style.width       = '0%';

  $('disp-fps').textContent = '--';
  $('inf-fps').textContent  = '--';
  $('pfr').textContent      = '--';
  $('fl').textContent       = 'FRAME 0 / 0';

  $('fi').value  = '';
  selectedFile   = null;
  currentJobId   = null;
  currentMode    = null;
  isPaused       = false;
}

// Start Streaming
function startStream(jobId) {
  es = new EventSource(`${API}/stream/${jobId}`);

  let dispFrames = 0;
  let dispT0     = Date.now();

  es.onmessage = e => {
    const d = JSON.parse(e.data);

    if (d.done) {
      es.close();
      es = null;
      $('db').classList.remove('hidden');
      $('hs').textContent      = 'COMPLETE';
      $('rd').style.background = '#22c55e';
      $('stopBtn').classList.add('hidden');
      $('pauseBtn').classList.add('hidden');
      $('newVideoBtn').classList.remove('hidden');
      return;
    }

    // Browser-side display FPS
    dispFrames++;
    const dispElapsed = (Date.now() - dispT0) / 1000;
    if (dispElapsed >= 1.0) {
      $('disp-fps').textContent = (dispFrames / dispElapsed).toFixed(1);
      dispFrames = 0;
      dispT0     = Date.now();
    }

    $('vf').src         = 'data:image/jpeg;base64,' + d.b64;
    $('fl').textContent = d.is_webcam ? 'WEBCAM LIVE' : `FRAME ${d.frame_num} / ${d.total_frames}`;

    $('ss').textContent = d.n_students;
    $('sn').textContent = d.n_students - d.n_suspicious;
    $('sx').textContent = d.n_suspicious;

    const m = String(Math.floor(d.elapsed / 60)).padStart(2, '0');
    const s = String(Math.floor(d.elapsed % 60)).padStart(2, '0');
    $('se').textContent = `${m}:${s}`;

    if (!d.is_webcam) {
      const pct = d.total_frames > 0 ? (d.frame_num / d.total_frames * 100).toFixed(1) : 0;
      $('vp').style.width = pct + '%';
    }

    $('inf-fps').textContent = d.inf_fps.toFixed(1);
    $('pfr').textContent     = d.is_webcam ? 'LIVE' : `${d.frame_num} / ${d.total_frames}`;

    if (d.annotations?.length) {
      $('rp').innerHTML = d.annotations.map(a => {
        const color = a.label === 'Suspicious' ? '#ef4444' : '#22c55e';
        const text  = a.prob < 0
          ? `${a.label} | skip`
          : `${a.label} | p=${a.prob.toFixed(5)}`;
        return `<div class="flex justify-between py-0.5 border-b border-border fm text-xs">
                  <span class="text-muted">ID:${String(a.track_id).padStart(2, '0')}</span>
                  <span style="color:${color}">${text}</span>
                </div>`;
      }).join('');
    }

    if (d.activity_log?.length) {
      const logEl   = $('al');
      const emptyEl = logEl.querySelector('.empty-log');
      if (emptyEl) logEl.innerHTML = '';

      const existing = new Set(
        Array.from(logEl.querySelectorAll('.lt')).map(el => el.textContent)
      );

      d.activity_log.forEach(entry => {
        const txt = `${entry.time} | ID:${String(entry.track_id).padStart(2, '0')} | Suspicious | p=${entry.resnet_prob.toFixed(5)}`;
        if (!existing.has(txt)) {
          const div     = document.createElement('div');
          div.className = 'fi flex items-center gap-2 py-1 border-b border-border';
          div.innerHTML = `<div class="w-2 h-2 rounded-full bg-red-500 shrink-0"></div>
                           <span class="lt fm text-muted text-xs">${txt}</span>`;
          logEl.insertBefore(div, logEl.firstChild);
          existing.add(txt);
        }
      });
    }
  };

  es.onerror = () => console.warn('SSE connection error');
}
</script>
</body>
</html>